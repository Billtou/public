utility_meter:
  taipower_energy:
    source: sensor.energy_sum

template:
  - sensor:
      - name: realtime_hour_cost
        unique_id: 239010d0-fd00-4615-ab05-b8964563370e
        state: "{{((states.sensor.power_sum.state|float)/1000 *(states.sensor.kwh_cost.state|float))|round(1)}}"
        unit_of_measurement: "$"

      - name: cycle_kwh_cost
        unique_id: 2ca5f2b9-edb4-4b2a-b1aa-50607618df7c
        state: >
          {% if now().month in [6,7,8,9] %}
            {% if states("sensor.taipower_energy") | float < 120 %}
              {{1.63}}
            {% elif states("sensor.taipower_energy") | float >= 120  and states("sensor.taipower_energy") | float < 330 %}
              {{2.38}}
            {% elif states("sensor.taipower_energy") | float >= 330  and states("sensor.taipower_energy") | float < 500 %}
              {{3.52}}
            {% elif states("sensor.taipower_energy") | float >= 500  and states("sensor.taipower_energy") | float < 700 %}
              {{4.8}}
            {% elif states("sensor.taipower_energy") | float >= 700  and states("sensor.taipower_energy") | float < 1000 %}
              {{5.66}}
            {% elif states("sensor.taipower_energy") | float >= 1000 %}
              {{6.99}}
            {% endif %}
          {% else %}
            {% if states("sensor.taipower_energy") | float < 120 %}
              {{1.63}}
            {% elif states("sensor.taipower_energy") | float >= 120  and states("sensor.taipower_energy") | float < 330 %}
              {{2.1}}
            {% elif states("sensor.taipower_energy") | float >= 330  and states("sensor.taipower_energy") | float < 500 %}
              {{2.89}}
            {% elif states("sensor.taipower_energy") | float >= 500  and states("sensor.taipower_energy") | float < 700 %}
              {{3.94}}
            {% elif states("sensor.taipower_energy") | float >= 700  and states("sensor.taipower_energy") | float < 1000 %}
              {{4.6}}
            {% elif states("sensor.taipower_energy") | float >= 1000 %}
              {{5.48}}
            {% endif %}
          {% endif %}
        unit_of_measurement: "TWD/kWh"
        device_class: monetary

      - name: cycle_power_cost
        unique_id: f53b6ccf-becb-48ab-a473-80f239199ea8
        state: >
          {% if now().month in [6,7,8,9] %}
            {% if states("sensor.taipower_energy") | float < 120 %}
              {{(states("sensor.taipower_energy") | float * states("sensor.kwh_cost") | float) | round(0)}}
            {% elif states("sensor.taipower_energy") | float >= 120  and states("sensor.taipower_energy") | float < 330 %}
              {{(((states("sensor.taipower_energy") | float - 120) * states("sensor.kwh_cost") | float) + 195.6) | round(0)}}
            {% elif states("sensor.taipower_energy") | float >= 330  and states("sensor.taipower_energy") | float < 550 %}
              {{(((states("sensor.taipower_energy") | float - 330) * states("sensor.kwh_cost") | float) + 695.4) | round(0)}}
            {% elif states("sensor.taipower_energy") | float >= 550  and states("sensor.taipower_energy") | float < 700 %}
              {{(((states("sensor.taipower_energy") | float - 550) * states("sensor.kwh_cost") | float) + 1293.8) | round(0)}}
            {% elif states("sensor.taipower_energy") | float >= 700  and states("sensor.taipower_energy") | float < 1000 %}
              {{(((states("sensor.taipower_energy") | float - 700) * states("sensor.kwh_cost") | float) + 2253.8) | round(0)}}
            {% elif states("sensor.taipower_energy") | float >= 1000 %}
              {{(((states("sensor.taipower_energy") | float - 1000) * states("sensor.kwh_cost") | float) + 3951.8) | round(0)}}
            {% endif %}
          {% else %}
            {% if states("sensor.taipower_energy") | float < 120 %}
              {{(states("sensor.taipower_energy") | float * states("sensor.kwh_cost") | float) | round(0)}}
            {% elif states("sensor.taipower_energy") | float >= 120  and states("sensor.taipower_energy") | float < 330 %}
              {{(((states("sensor.taipower_energy") | float - 120) * states("sensor.kwh_cost") | float) + 195.6) | round(0)}}
            {% elif states("sensor.taipower_energy") | float >= 330  and states("sensor.taipower_energy") | float < 1000 %}
              {{(((states("sensor.taipower_energy") | float - 330) * states("sensor.kwh_cost") | float) + 636.6) | round(0)}}
            {% elif states("sensor.taipower_energy") | float >= 1000  and states("sensor.taipower_energy") | float < 700 %}
              {{(((states("sensor.taipower_energy") | float - 1000) * states("sensor.kwh_cost") | float) + 1143.2) | round(0)}}
            {% elif states("sensor.taipower_energy") | float >= 700  and states("sensor.taipower_energy") | float < 1000 %}
              {{(((states("sensor.taipower_energy") | float - 700) * states("sensor.kwh_cost") | float) + 1931.2) | round(0)}}
            {% elif states("sensor.taipower_energy") | float >= 1000 %}
              {{(((states("sensor.taipower_energy") | float - 1000) * states("sensor.kwh_cost") | float) + 3311.2) | round(0)}}
            {% endif %}
          {% endif %}
        unit_of_measurement: "TWD"
        device_class: monetary
